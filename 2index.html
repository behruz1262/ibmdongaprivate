<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Portfolio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-950 text-white min-h-screen p-6 space-y-10">

  <!-- Header -->
  <header class="text-center space-y-2">
    <h1 class="text-4xl font-bold text-teal-400">Student Portfolio</h1>
    <p class="text-gray-400">Upload Assignments, Share Links, and Track Everything</p>
  </header>

  <!-- Upload Form -->
  <section class="bg-gray-900 rounded-xl px-6 py-5 shadow-lg space-y-5">
    <h2 class="text-2xl font-bold text-teal-400 mb-2">Upload</h2>
    <form id="uploadForm" class="grid gap-4 sm:grid-cols-2">
      <div class="col-span-2">
        <label class="block mb-1 text-gray-300" for="folderName">Folder Name</label>
        <input type="text" id="folderName" class="w-full p-2 rounded bg-gray-800 text-white" placeholder="e.g. Week 8" required />
      </div>
      <div>
        <label class="block mb-1 text-gray-300" for="fileUpload">Upload File</label>
        <input type="file" id="fileUpload" class="w-full p-2 rounded bg-gray-800 text-white" />
      </div>
      <div>
        <label class="block mb-1 text-gray-300" for="linkUrl">Or Paste Link</label>
        <input type="url" id="linkUrl" class="w-full p-2 rounded bg-gray-800 text-white" placeholder="https://..." />
      </div>
      <div class="col-span-2">
        <button type="submit" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded">
          Upload
        </button>
      </div>
    </form>
  </section>

  <!-- Uploaded Content -->
  <section id="uploadedContent" class="space-y-10"></section>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwUseKu14L_kmA9KPVngixxL30vKNL6aAWVp4mjkHzwUiPi_BwgULQqE2YEspmiIyQYSg/exec";
    const uploadedContent = document.getElementById('uploadedContent');

    async function loadFiles() {
      uploadedContent.innerHTML = "<p class='text-gray-400'>Loading...</p>";
      try {
        const res = await fetch(scriptURL);
        const files = await res.json();
        const folders = {};

        // Group by folder
        files.forEach(file => {
          if (!folders[file.folder]) folders[file.folder] = [];
          folders[file.folder].push(file);
        });

        uploadedContent.innerHTML = '';
        for (const [folder, items] of Object.entries(folders)) {
          const section = document.createElement('section');
          section.className = "bg-gray-900 rounded-xl px-6 py-5 shadow-lg";
          section.innerHTML = `<h2 class="text-2xl font-bold text-teal-400 mb-3">📁 ${folder}</h2><ul class="space-y-2"></ul>`;
          const list = section.querySelector('ul');

          items.forEach(file => {
            const li = document.createElement('li');
            li.className = "bg-gray-800 p-3 rounded flex justify-between items-center";
            const icon = file.link ? '🔗' : getFileIcon(file.name || '');
            li.innerHTML = `
              <div>
                <a href="${file.url}" target="_blank" class="text-teal-300 hover:underline">${icon} ${file.name}</a>
              </div>
              <button class="text-red-400 hover:text-red-600" onclick="deleteFile('${file.id}')">Delete</button>
            `;
            list.appendChild(li);
          });

          uploadedContent.appendChild(section);
        }

      } catch (err) {
        uploadedContent.innerHTML = "<p class='text-red-500'>Failed to load files.</p>";
      }
    }

    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const icons = {
        pdf: '📄',
        doc: '📝',
        docx: '📝',
        xls: '📊',
        xlsx: '📊',
        ppt: '📽️',
        pptx: '📽️',
        jpg: '🖼️',
        jpeg: '🖼️',
        png: '🖼️',
        gif: '🖼️',
        zip: '🗜️',
        rar: '🗜️',
        mp4: '🎞️',
        mp3: '🎵',
        txt: '📃',
      };
      return icons[ext] || '📁';
    }

    document.getElementById('uploadForm').addEventListener('submit', async function (event) {
      event.preventDefault();
      const folder = document.getElementById('folderName').value.trim();
      const fileInput = document.getElementById('fileUpload');
      const file = fileInput.files[0];
      const linkUrl = document.getElementById('linkUrl').value.trim();

      if (!folder || (!file && !linkUrl)) {
        alert("Please provide a folder and either a file or a link.");
        return;
      }

      const formData = new FormData();
      formData.append('folder', folder);

      if (file) {
        const reader = new FileReader();
        reader.onload = async function () {
          const base64 = reader.result.split(',')[1];
          formData.append('filename', file.name);
          formData.append('mimeType', file.type);
          formData.append('file', base64);

          try {
            await fetch(scriptURL, { method: "POST", body: formData });
            loadFiles();
            document.getElementById('uploadForm').reset();
          } catch (err) {
            alert("Upload failed.");
          }
        };
        reader.readAsDataURL(file);
      } else if (linkUrl) {
        formData.append('link', linkUrl);
        formData.append('filename', folder + "-link");
        try {
          await fetch(scriptURL, { method: "POST", body: formData });
          loadFiles();
          document.getElementById('uploadForm').reset();
        } catch (err) {
          alert("Link upload failed.");
        }
      }
    });

    async function deleteFile(fileId) {
      if (!confirm("Are you sure you want to delete this file?")) return;
      try {
        await fetch(scriptURL + "?delete=" + fileId);
        loadFiles();
      } catch (err) {
        alert("Delete failed.");
      }
    }

    loadFiles();
  </script>
</body>
</html>
