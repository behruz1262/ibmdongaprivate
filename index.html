<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Yuldoshev Behruz's Portfolio and Assignment Manager">
  <title>Information Management - Yuldoshev Behruz</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <style>
    :root {
      --primary-color: #00ff00;
      --primary-hover: #00cc00;
      --bg-dark: #000;
      --bg-section: #1a1a1a;
      --delete-btn: #ff4444;
      --delete-hover: #cc0000;
      --text-light: #fff;
      --text-muted: #ccc;
      --header-bg: #111;
      --transition-speed: 0.3s;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-light);
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }

    header {
      background-color: var(--header-bg);
      padding: 40px 20px;
      text-align: center;
      border-bottom: 2px solid var(--primary-color);
    }

    header h1 {
      margin: 0;
      font-size: 2.5em;
      color: var(--primary-color);
    }

    header p {
      margin: 10px 0 0;
      font-size: 1.2em;
      color: var(--text-muted);
    }

    main {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    section {
      margin-bottom: 40px;
      background-color: var(--bg-section);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    h2 {
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 10px;
      font-size: 1.8em;
      display: flex;
      align-items: center;
    }

    h2 i {
      margin-right: 10px;
    }

    ul {
      list-style-type: none;
      padding: 0;
    }

    ul li {
      margin: 15px 0;
      display: flex;
      flex-direction: column;
    }

    ul li a {
      color: var(--primary-color);
      text-decoration: none;
      font-size: 1.1em;
      transition: color var(--transition-speed) ease;
      word-break: break-word;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    ul li a:hover {
      color: var(--primary-hover);
      text-decoration: underline;
    }

    ul li button {
      align-self: flex-start;
      background-color: var(--delete-btn);
      color: var(--text-light);
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 0.9em;
      border-radius: 5px;
      transition: background-color var(--transition-speed) ease;
      margin-top: 5px;
    }

    ul li button:hover {
      background-color: var(--delete-hover);
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="url"],
    select {
      width: 100%;
      padding: 8px 12px;
      border-radius: 5px;
      border: 1px solid #333;
      background-color: #222;
      color: var(--text-light);
      margin-bottom: 10px;
    }

    input[type="file"] {
      margin: 10px 0;
    }

    button[type="submit"] {
      background-color: var(--primary-color);
      color: #000;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color var(--transition-speed) ease;
    }

    button[type="submit"]:hover {
      background-color: var(--primary-hover);
    }

    button[type="submit"]:disabled {
      background-color: #555;
      cursor: not-allowed;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--text-light);
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      border-radius: 5px;
      color: var(--text-light);
      opacity: 0;
      transition: opacity var(--transition-speed) ease;
      z-index: 1000;
    }

    .toast.success {
      background-color: #4caf50;
    }

    .toast.error {
      background-color: #f44336;
    }

    .toast.show {
      opacity: 1;
    }

    .folder-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
      padding: 8px;
      background-color: #222;
      border-radius: 5px;
    }

    .file-icon {
      width: 20px;
      text-align: center;
    }

    /* Responsive styles */
    @media screen and (max-width: 600px) {
      header {
        padding: 20px 10px;
      }

      header h1 {
        font-size: 2em;
      }

      section {
        padding: 15px;
      }
    }

    @media screen and (max-width: 480px) {
      body {
        font-size: 14px;
      }
      
      button[type="submit"] {
        width: 100%;
      }

      input[type="file"] {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Yuldoshev Behruz's Portfolio</h1>
    <p>Your current grade is: <span id="grade-value">Loading...</span></p>
  </header>
  <main>
    <section>
      <h2><i class="fas fa-folder"></i> Manage Folders</h2>
      <form id="folder-form" aria-label="Create folder form">
        <div class="form-group">
          <label for="folder-name">Folder Name</label>
          <input type="text" id="folder-name" placeholder="Enter folder name" required aria-required="true">
        </div>
        <button type="submit" id="create-folder-btn">Create Folder</button>
      </form>
      <div id="folder-list-container" style="margin-top: 20px;">
        <h3>Existing Folders</h3>
        <ul id="folder-list"></ul>
      </div>
    </section>
    <section>
      <h2><i class="fas fa-file-upload"></i> Upload Assignment</h2>
      <form id="upload-form" aria-label="Upload assignment form">
        <div class="form-group">
          <label for="folder-select">Select Folder</label>
          <select id="folder-select" aria-required="true">
            <option value="">-- Select Folder --</option>
          </select>
        </div>
        <div class="form-group">
          <label for="file-input">Choose File</label>
          <input type="file" id="file-input" aria-describedby="file-format-info">
          <small id="file-format-info">Accepts all file formats</small>
        </div>
        <div class="form-group">
          <label for="link-input">Or Enter URL</label>
          <input type="url" id="link-input" placeholder="https://example.com/file.pdf">
        </div>
        <button type="submit" id="upload-btn">Upload</button>
      </form>
    </section>
    <section>
      <h2><i class="fas fa-folder-open"></i> Uploaded Files</h2>
      <div id="folders-container" aria-live="polite"></div>
    </section>
  </main>
  <div id="toast" class="toast" role="alert" aria-live="assertive"></div>

  <script>
    // Utility functions
    const Toast = {
      element: document.getElementById('toast'),
      show(message, type = 'success') {
        this.element.textContent = message;
        this.element.className = `toast ${type} show`;
        setTimeout(() => {
          this.element.className = 'toast';
        }, 3000);
      }
    };

    const safeHTML = (str) => {
      const temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    };

    // Storage Management with error handling
    const Storage = {
      get(key, defaultValue = {}) {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : defaultValue;
        } catch (error) {
          console.error(`Error getting ${key} from localStorage:`, error);
          return defaultValue;
        }
      },
      
      set(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
          return true;
        } catch (error) {
          console.error(`Error saving ${key} to localStorage:`, error);
          Toast.show('Error saving data. Local storage may be full or disabled.', 'error');
          return false;
        }
      }
    };

    // File URL Manager to prevent memory leaks
    const FileURLManager = {
      urls: new Set(),
      
      create(blob) {
        const url = URL.createObjectURL(blob);
        this.urls.add(url);
        return url;
      },
      
      revoke(url) {
        if (this.urls.has(url)) {
          URL.revokeObjectURL(url);
          this.urls.delete(url);
        }
      },
      
      clear() {
        this.urls.forEach(url => URL.revokeObjectURL(url));
        this.urls.clear();
      }
    };

    // File type to icon mapping
    const FileIcons = {
      getIcon(filename) {
        const extension = filename.split('.').pop().toLowerCase();
        
        const iconMap = {
          // Documents
          pdf: 'fa-file-pdf',
          doc: 'fa-file-word',
          docx: 'fa-file-word',
          txt: 'fa-file-alt',
          rtf: 'fa-file-alt',
          
          // Spreadsheets
          xls: 'fa-file-excel',
          xlsx: 'fa-file-excel',
          csv: 'fa-file-csv',
          
          // Presentations
          ppt: 'fa-file-powerpoint',
          pptx: 'fa-file-powerpoint',
          
          // Archives
          zip: 'fa-file-archive',
          rar: 'fa-file-archive',
          '7z': 'fa-file-archive',
          tar: 'fa-file-archive',
          gz: 'fa-file-archive',
          
          // Code
          js: 'fa-file-code',
          html: 'fa-file-code',
          css: 'fa-file-code',
          php: 'fa-file-code',
          py: 'fa-file-code',
          java: 'fa-file-code',
          cpp: 'fa-file-code',
          h: 'fa-file-code',
          
          // Images
          jpg: 'fa-file-image',
          jpeg: 'fa-file-image',
          png: 'fa-file-image',
          gif: 'fa-file-image',
          bmp: 'fa-file-image',
          svg: 'fa-file-image',
          
          // Audio/Video
          mp3: 'fa-file-audio',
          wav: 'fa-file-audio',
          mp4: 'fa-file-video',
          mov: 'fa-file-video',
          avi: 'fa-file-video',
          
          // Default
          default: 'fa-file'
        };
        
        return iconMap[extension] || iconMap.default;
      }
    };

    // Main app code
    const PortfolioApp = {
      folderData: {},
      
      init() {
        this.folderData = Storage.get('folders', {});
        this.setupEventListeners();
        this.refreshFolderSelect();
        this.refreshFolderList();
        this.refreshFoldersDisplay();
        this.fetchGrade();
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
          FileURLManager.clear();
        });
      },
      
      setupEventListeners() {
        document.getElementById('folder-form').addEventListener('submit', this.handleFolderCreate.bind(this));
        document.getElementById('upload-form').addEventListener('submit', this.handleFileUpload.bind(this));
        
        // Add validation feedback for inputs
        document.getElementById('folder-name').addEventListener('input', function() {
          this.setCustomValidity('');
          this.checkValidity();
        });
        
        document.getElementById('folder-name').addEventListener('invalid', function() {
          if (this.value === '') {
            this.setCustomValidity('Please enter a folder name');
          }
        });
      },
      
      refreshFolderSelect() {
        const select = document.getElementById('folder-select');
        const currentValue = select.value;
        
        // Clear and rebuild the select options
        select.innerHTML = '<option value="">-- Select Folder --</option>';
        
        Object.keys(this.folderData).forEach(folder => {
          const option = document.createElement('option');
          option.value = folder;
          option.textContent = folder;
          select.appendChild(option);
        });
        
        // Restore previous selection if it still exists
        if (currentValue && Object.keys(this.folderData).includes(currentValue)) {
          select.value = currentValue;
        }
      },
      
      refreshFolderList() {
        const folderList = document.getElementById('folder-list');
        folderList.innerHTML = '';
        
        Object.keys(this.folderData).forEach(folder => {
          const li = document.createElement('li');
          li.className = 'folder-item';
          
          const nameSpan = document.createElement('span');
          nameSpan.textContent = folder;
          
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Delete';
          deleteBtn.style.backgroundColor = 'var(--delete-btn)';
          deleteBtn.addEventListener('click', () => this.deleteFolder(folder));
          
          li.appendChild(nameSpan);
          li.appendChild(deleteBtn);
          folderList.appendChild(li);
        });
      },
      
      refreshFoldersDisplay() {
        const container = document.getElementById('folders-container');
        
        // Clear container
        container.innerHTML = '';
        
        if (Object.keys(this.folderData).length === 0) {
          const emptyMsg = document.createElement('p');
          emptyMsg.textContent = 'No folders created yet. Create a folder to get started.';
          container.appendChild(emptyMsg);
          return;
        }
        
        // Create folder sections
        Object.entries(this.folderData).forEach(([folderName, files]) => {
          const folderSection = document.createElement('section');
          
          // Create folder header with folder name and file count
          const folderHeader = document.createElement('h3');
          folderHeader.textContent = `${folderName} (${files.length} file${files.length === 1 ? '' : 's'})`;
          folderSection.appendChild(folderHeader);
          
          if (files.length === 0) {
            const emptyNote = document.createElement('p');
            emptyNote.textContent = 'No files in this folder.';
            folderSection.appendChild(emptyNote);
          } else {
            const fileList = document.createElement('ul');
            fileList.setAttribute('aria-label', `Files in ${folderName}`);
            
            files.forEach((file, index) => {
              const listItem = document.createElement('li');
              
              // Create file link
              const fileLink = document.createElement('a');
              if (file.url.endsWith('.doc') || file.url.endsWith('.docx')) {
                fileLink.href = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(file.url)}`;
              } else {
                fileLink.href = file.url;
              }
              fileLink.target = "_blank";
              fileLink.rel = "noopener noreferrer";
              
              // Add file icon
              const fileIcon = document.createElement('i');
              fileIcon.className = `fas ${FileIcons.getIcon(file.name)} file-icon`;
              fileLink.appendChild(fileIcon);
              
              // Add file name
              const fileNameSpan = document.createElement('span');
              fileNameSpan.textContent = file.name;
              fileLink.appendChild(fileNameSpan);
              
              // Create delete button
              const deleteBtn = document.createElement('button');
              deleteBtn.textContent = 'Delete';
              deleteBtn.setAttribute('aria-label', `Delete ${file.name}`);
              deleteBtn.addEventListener('click', () => this.deleteFile(folderName, index));
              
              // Append elements
              listItem.appendChild(fileLink);
              listItem.appendChild(deleteBtn);
              fileList.appendChild(listItem);
            });
            
            folderSection.appendChild(fileList);
          }
          
          container.appendChild(folderSection);
        });
      },
      
      handleFolderCreate(e) {
        e.preventDefault();
        const input = document.getElementById('folder-name');
        const folderName = input.value.trim();
        const button = document.getElementById('create-folder-btn');
        
        // Validation
        if (!folderName) {
          input.setCustomValidity('Please enter a folder name');
          input.reportValidity();
          return;
        }
        
        if (this.folderData[folderName]) {
          input.setCustomValidity('This folder already exists');
          input.reportValidity();
          return;
        }
        
        // Disable button during operation
        button.disabled = true;
        button.innerHTML = 'Creating... <span class="spinner"></span>';
        
        // Create folder with slight delay to show the operation
        setTimeout(() => {
          this.folderData[folderName] = [];
          const saved = Storage.set('folders', this.folderData);
          
          if (saved) {
            input.value = '';
            this.refreshFolderSelect();
            this.refreshFolderList();
            this.refreshFoldersDisplay();
            Toast.show(`Folder "${folderName}" created successfully`);
          }
          
          // Re-enable button
          button.disabled = false;
          button.textContent = 'Create Folder';
        }, 500);
      },
      
      handleFileUpload(e) {
        e.preventDefault();
        const fileInput = document.getElementById('file-input');
        const linkInput = document.getElementById('link-input');
        const folderSelect = document.getElementById('folder-select');
        const button = document.getElementById('upload-btn');
        
        const folder = folderSelect.value;
        const file = fileInput.files[0];
        const link = linkInput.value.trim();
        
        // Validation
        if (!folder) {
          Toast.show('Please select a folder', 'error');
          return;
        }
        
        if (!file && !link) {
          Toast.show('Please either select a file or provide a URL', 'error');
          return;
        }
        
        if (file && link) {
          Toast.show('Please provide either a file OR a URL, not both', 'error');
          return;
        }
        
        // Disable button during operation
        button.disabled = true;
        button.innerHTML = 'Uploading... <span class="spinner"></span>';
        
        setTimeout(() => {
          try {
            const newFile = {
              name: file ? file.name : link.split('/').pop() || 'External Link',
              url: file ? FileURLManager.create(file) : link,
              type: file ? 'file' : 'link',
              timestamp: new Date().toISOString()
            };
            
            this.folderData[folder].push(newFile);
            const saved = Storage.set('folders', this.folderData);
            
            if (saved) {
              fileInput.value = '';
              linkInput.value = '';
              this.refreshFoldersDisplay();
              Toast.show('File uploaded successfully');
            }
          } catch (error) {
            console.error('Upload error:', error);
            Toast.show('Error uploading file', 'error');
          } finally {
            button.disabled = false;
            button.textContent = 'Upload';
          }
        }, 500);
      },
      
      deleteFile(folderName, index) {
        if (confirm('Are you sure you want to delete this file?')) {
          const file = this.folderData[folderName][index];
          
          // Revoke object URL if it's a file
          if (file.type === 'file') {
            FileURLManager.revoke(file.url);
          }
          
          this.folderData[folderName].splice(index, 1);
          Storage.set('folders', this.folderData);
          this.refreshFoldersDisplay();
          Toast.show('File deleted successfully');
        }
      },
      
      deleteFolder(folderName) {
        if (this.folderData[folderName] && this.folderData[folderName].length > 0) {
          if (!confirm(`Folder "${folderName}" contains files. Are you sure you want to delete it?`)) {
            return;
          }
          
          // Clean up any file URLs
          this.folderData[folderName].forEach(file => {
            if (file.type === 'file') {
              FileURLManager.revoke(file.url);
            }
          });
        }
        
        delete this.folderData[folderName];
        Storage.set('folders', this.folderData);
        this.refreshFolderSelect();
        this.refreshFolderList();
        this.refreshFoldersDisplay();
        Toast.show(`Folder "${folderName}" deleted`);
      },
      
      fetchGrade() {
  const webAppUrl = 'https://script.google.com/macros/s/AKfycbw5UUHQ0WXVoY_5TRXH1r2lneSsMIIEz2i4mOJ8x1OjNXOrUEsPSDJVk3w4DVCh4hJw/exec'; // Paste the URL from Step 3
  
 fetch(webAppUrl)
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.json();
    })
    .then(data => {
      console.log('Grade API response:', data);

      if (!data.letterGrade || typeof data.percentage !== 'number') {
        throw new Error('Invalid grade data format');
      }

      const gradeText = `${data.letterGrade} (${data.percentage}%)`;
      updateGradeDisplay(gradeText);

      // Save grade for offline fallback
      Storage.set('userGrade', {
        value: gradeText,
        rawData: data,
        cachedAt: new Date().toISOString()
      });
    })
    .catch(error => {
      console.error('Error fetching grade:', error);

      // Try fallback
      const cachedGrade = Storage.get('userGrade', { value: 'Grade data unavailable' });
      updateGradeDisplay(cachedGrade.value);
   
    });
}
  </script>
</body>
</html>
